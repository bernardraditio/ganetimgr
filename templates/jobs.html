{% extends "theme/base.html" %}
{% load i18n %}
{% block extrahead %}

<style>
.dropdown-menu.instanceopt{
	right: 0px;
	left: auto;
	text-align: left !important;
}

.alignCenter{
	text-align: center !important;
}
.alignLeft{
	text-align: left !important;
}
.alignRight{
	text-align: right !important;
}
.visoverflow{
	overflow: visible;
}
</style>
<link rel="stylesheet" type="text/css" href="/static/css/bootstrap-switch.css">

{% endblock %}
{% block title %}{% trans "Jobs" %}{% endblock %}
{% block clusterjobs %}class="active"{% endblock %}
{% block content %}
<div class="span12 main-content">

    <div class="row-fluid">
        <div class="row-fluid">
            <h2>{% trans "Clusters Jobs" %}
            </h2>

<table class="table table-first-column-number data-table display full visoverflow" id="jobs_table">
<thead>
<tr>
	<th style="text-align: center;">{% trans "Job Id" %} <span class="sort-icon"></span></th>
	<th style="text-align: center;">{% trans "Cluster" %} <span class="sort-icon"></span></th>
	<th style="text-align: center;">{% trans "Status" %} <span class="sort-icon"></span></th>
	<th style="text-align: center;">{% trans "Opcode Id" %} <span class="sort-icon"></span></th>
	<th style="text-align: center;">{% trans "Start" %} <span class="sort-icon"></span></th>
	
</tr>

</thead>
<tbody>

</tbody>
</table>

</div>
</div>
</div>

<div class="modal hide fade" id="instDets" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
<h3 id="myModalLabelservdets">{% trans "Job Details" %}</h3>
</div>
<div class="modal-body" id="instDetsbody">

</div>
<div class="modal-footer">
<button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Close" %}</button>
</div>
</div>

{% endblock %}
{% block bottomblock %}

<script type="text/javascript" src="/static/theme/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/theme/js/jquery.dataTables.bootstrap.js"></script>
<script type="text/javascript" src="/static/js/jquery_csrf_protect.js"></script>
<script type="text/javascript">
var oTable;
var ajaxSource;

 $.fn.dataTableExt.oApi.fnReloadAjax = function ( oSettings, sNewSource, fnCallback, bStandingRedraw )
{   
    // DataTables 1.10 compatibility - if 1.10 then versionCheck exists.
    // 1.10s API has ajax reloading built in, so we use those abilities
    // directly.
    if ( $.fn.dataTable.versionCheck ) {
        var api = new $.fn.dataTable.Api( oSettings );
 
        if ( sNewSource ) {
            api.ajax.url( sNewSource ).load( fnCallback, !bStandingRedraw );
        }
        else {
            api.ajax.reload( fnCallback, !bStandingRedraw );
        }
        return;
    }
 
    if ( sNewSource !== undefined && sNewSource !== null ) {
        oSettings.sAjaxSource = sNewSource;
    }
 
    // Server-side processing should just call fnDraw
    if ( oSettings.oFeatures.bServerSide ) {
        this.fnDraw();
        return;
    }
 
    this.oApi._fnProcessingDisplay( oSettings, true );
    var that = this;
    var iStart = oSettings._iDisplayStart;
    var aData = [];
 
    this.oApi._fnServerParams( oSettings, aData );
 
    oSettings.fnServerData.call( oSettings.oInstance, oSettings.sAjaxSource, aData, function(json) {
        /* Clear the old information from the table */
        that.oApi._fnClearTable( oSettings );
 
        /* Got the data - add it to the table */
        var aData =  (oSettings.sAjaxDataProp !== "") ?
            that.oApi._fnGetObjectDataFn( oSettings.sAjaxDataProp )( json ) : json;
 
        for ( var i=0 ; i<aData.length ; i++ )
        {
            that.oApi._fnAddData( oSettings, aData[i] );
        }
         
        oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
 
        that.fnDraw();
 
        if ( bStandingRedraw === true )
        {
            oSettings._iDisplayStart = iStart;
            that.oApi._fnCalculateEnd( oSettings );
            that.fnDraw( false );
        }
 
        that.oApi._fnProcessingDisplay( oSettings, false );
 
        /* Callback user function - for event handlers etc */
        if ( typeof fnCallback == 'function' && fnCallback !== null )
        {
            fnCallback( oSettings );
        }
    }, oSettings );
};
$(document).ready( function(){
   

	ajaxSource = "{% url jobs_json %}";
	oTable = $('#jobs_table').dataTable( {
		"bPaginate": true,
	    "bFilter": true,
	    "bAutoWidth": true,
	    "bStateSave": true,
	    "oLanguage": {
	    	"sLengthMenu": '{% trans "Display" %} <select><option value="20">20</option><option value="50">50</option><option value="-1">{% trans "All" %}</option></select> {% trans "jobs" %}'
	    },
	    "sPaginationType": "bootstrap",
	    "sDom": "<'row-fluid'<'span6'l><'span6'f>ip>tr<'row-fluid'<'span6'i><'span6'p>>",
	    "iDisplayLength": 20,
		"bProcessing": true,
        "sAjaxSource": ajaxSource,
        "bDeferRender": true,
        "fnInitComplete": function(oSettings, json) {
            if(json.hasOwnProperty('messages')){
            	$('#jsonmessages').show();
            	$('#jsonmessage').html(json.messages);
            }
          },
        "aaSorting": [[ 4, "desc" ]],
        "aoColumns":[
                     {"mData":"id", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender":  function (data, type, full) {
                             var ret = ''+
                               '<a class="btn btn-info btn-small" href="#" onclick="javascript:showDetails(\''+full.cluster+'\',\''+data+'\'); return false;">'+data+'</a>';
                     return ret;
                     }},
                     {"mData":"cluster", "sClass" : "alignCenter","bSearchable": true,"bSortable": true},
                     {"mData":"status", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
	                     if (data == "success"){
                       	 	status = '<span class="label label-success">Success</span>';
                         }
                         if (data == "error"){
                       	  status = '<span class="label label-important">Error</span>';
                         }
                         if (data == "waiting"){
                       	  status = '<span class="label label-info">Waiting</span>';
                         }
                         if (data == "running"){
                       	  status = '<span class="label label-info">Running</span>';
                         }
                         return status;
                         }},
                     {"mData":"ops.0.OP_ID", "sClass" : "alignCenter", "bSearchable": true,"bSortable": true},
                     {"mData":"start_time", "sClass" : "alignCenter", "bSearchable": true,"bSortable": true},                     
         ]
} );

var tid = setInterval(refreshJobs, 5000);
function refreshJobs() {
  oTable.fnReloadAjax(ajaxSource);
}

  $(window).resize(function() {
    clearTimeout(window.refresh_size);
    window.refresh_size = setTimeout(function() { update_size(); }, 250);
  });
  
var update_size = function() {
    $(oTable).css({ width: $(oTable).parent().width() });
    oTable.fnAdjustColumnSizing(); 
  }

});

	function showDetails(cluster, jobid){
		$( "#instDetsbody" ).html( "" );
		$( "#myModalLabelservdets" ).text('Job Details: '+jobid);
		$( "#instDetsbody" ).load("{% url jobdets-popup %}/?cluster="+cluster+"&jobid="+jobid+"");
		$( "#instDets" ).modal('show');
		return false;
	}
	
</script>
{% endblock %}
